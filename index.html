<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Birthday Cake with Candles</title>
  <style>
    body {
      margin: 0;
      overflow: hidden;
      background-color: #ffe0f0;
      font-family: Arial, sans-serif;
    }

    .cake-container {
      position: relative;
      width: 300px;
      height: 250px;
      margin: 100px auto 0;
    }

    .cake {
      position: absolute;
      bottom: 0;
      width: 100%;
      height: 150px;
      background: #ff66b2;
      border-radius: 20px 20px 0 0;
      box-shadow: 0 0 0 10px #fff0f5;
    }

    .layer {
      position: absolute;
      width: 100%;
      height: 40px;
      background: #ff99cc;
      border-radius: 10px;
    }

    .layer:nth-child(1) {
      bottom: 100px;
    }

    .layer:nth-child(2) {
      bottom: 60px;
      background: #ffb3d9;
    }

    .layer:nth-child(3) {
      bottom: 20px;
      background: #ffcce6;
    }

    .candle {
      position: absolute;
      width: 6px;
      height: 20px;
      background: #fff;
      border-radius: 3px;
      transform: translate(-50%, -100%);
      animation: shake 0.1s infinite alternate;
    }

    .candle.out .flame {
      display: none;
    }

    .flame {
      width: 8px;
      height: 8px;
      background: yellow;
      border-radius: 50%;
      position: absolute;
      top: -10px;
      left: -1px;
      animation: flicker 0.2s infinite alternate;
    }

    @keyframes flicker {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.1); opacity: 0.8; }
    }

    @keyframes shake {
      0% { transform: translate(-50%, -100%) rotate(-1deg); }
      100% { transform: translate(-50%, -100%) rotate(1deg); }
    }

    #candleCountDisplay {
      text-align: center;
      margin-top: 20px;
      font-size: 20px;
      color: #d4006f;
    }

    canvas {
      position: fixed;
      top: 0;
      left: 0;
      pointer-events: none;
      z-index: -1;
    }
  </style>
</head>
<body>
  <canvas id="confettiCanvas"></canvas>

  <div class="cake-container">
    <div class="cake">
      <div class="layer"></div>
      <div class="layer"></div>
      <div class="layer"></div>
    </div>
  </div>

  <div id="candleCountDisplay">Candles: <span id="candleCount">0</span></div>

  <script>
    const canvas = document.getElementById("confettiCanvas");
    const ctx = canvas.getContext("2d");
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;

    const confettiCount = 150;
    const confetti = [];
    const colors = ["#ff4081", "#ffd740", "#69f0ae", "#40c4ff", "#ff80ab"];

    for (let i = 0; i < confettiCount; i++) {
      confetti.push({
        x: Math.random() * canvas.width,
        y: Math.random() * canvas.height,
        r: Math.random() * 6 + 4,
        d: Math.random() * confettiCount,
        color: colors[Math.floor(Math.random() * colors.length)],
        tilt: Math.floor(Math.random() * 10) - 10,
        tiltAngleIncremental: Math.random() * 0.07 + 0.05,
        tiltAngle: 0
      });
    }

    function drawConfetti() {
      ctx.clearRect(0, 0, canvas.width, canvas.height);
      for (let i = 0; i < confettiCount; i++) {
        const c = confetti[i];
        ctx.beginPath();
        ctx.lineWidth = c.r / 2;
        ctx.strokeStyle = c.color;
        ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
        ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
        ctx.stroke();
      }
      updateConfetti();
    }

    function updateConfetti() {
      for (let i = 0; i < confettiCount; i++) {
        const c = confetti[i];
        c.tiltAngle += c.tiltAngleIncremental;
        c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
        c.x += Math.sin(c.d);
        c.tilt = Math.sin(c.tiltAngle) * 15;

        if (c.y > canvas.height) {
          c.y = -10;
          c.x = Math.random() * canvas.width;
        }
      }
    }

    (function animateConfetti() {
      requestAnimationFrame(animateConfetti);
      drawConfetti();
    })();

    document.addEventListener("DOMContentLoaded", function () {
      const cake = document.querySelector(".cake");
      const candleCountDisplay = document.getElementById("candleCount");
      const candles = [];

      function updateCandleCount() {
        const activeCandles = candles.filter(
          (candle) => !candle.classList.contains("out")
        ).length;
        candleCountDisplay.textContent = activeCandles;
      }

      function addCandle(left, top) {
        const candle = document.createElement("div");
        candle.className = "candle";
        candle.style.left = left + "px";
        candle.style.top = top + "px";

        const flame = document.createElement("div");
        flame.className = "flame";
        candle.appendChild(flame);

        cake.appendChild(candle);
        candles.push(candle);
      }

      // Add 19 candles in a circle
      const centerX = 120;
      const centerY = 10;
      const radius = 90;

      const candleTotal = 19;
      for (let i = 0; i < candleTotal; i++) {
        const angle = (i / candleTotal) * 2 * Math.PI;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        addCandle(x, y);
      }

      updateCandleCount();
    });

    // Blow out candles using microphone
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(function(stream) {
        const audioContext = new (window.AudioContext || window.webkitAudioContext)();
        const source = audioContext.createMediaStreamSource(stream);
        const analyser = audioContext.createAnalyser();
        source.connect(analyser);
        analyser.fftSize = 512;

        const dataArray = new Uint8Array(analyser.frequencyBinCount);

        function checkVolume() {
          analyser.getByteFrequencyData(dataArray);
          const volume = dataArray.reduce((a, b) => a + b) / dataArray.length;

          if (volume > 60) {
            blowOutCandles();
          }

          requestAnimationFrame(checkVolume);
        }

        checkVolume();
      })
      .catch(function(err) {
        console.error("Microphone access denied:", err);
      });

    function blowOutCandles() {
      const candles = document.querySelectorAll(".candle");
      candles.forEach(candle => {
        candle.classList.add("out");
      });
      document.getElementById("candleCount").textContent = 0;
    }
  </script>
</body>
</html>
